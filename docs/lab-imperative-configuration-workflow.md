## 4.1.6 Lab: Imperative Configuration Workflow

This lab demonstrates the process of using rapid, imperative commands to configure a Deployment, extracting the resulting configuration into a clean YAML file, and then redeploying using the declarative approach. This is useful for building a working configuration quickly before committing it to source control.

**Goal:** Configure an Nginx Deployment imperatively, extract its final state into a clean `.yaml` file, and then use that file for declarative deployment.

#### Phase 1: Create and Configure Imperatively

1.  **Create the Secret:**
    ```bash
    kubectl create secret generic lab11secret --from-literal=MYPASSWORD=verysecret
    ```

2.  **Create the Base Deployment:**
    ```bash
    kubectl create deployment lab11deploy --image=nginx
    ```

3.  **Inject the Secret as an Environment Variable:**
    ```bash
    kubectl set env deployment lab11deploy --from=secret/lab11secret
    ```
    > Note: This command imperatively patches the Deployment to pull all data from the Secret and expose it as environment variables.*

4.  **Optional: Verify the Change**
    *You can use `kubectl edit` to see the resulting YAML manifest, which now includes the `envFrom` section referencing the Secret.*
    ```bash
    kubectl edit deployments.apps lab11deploy
    ```

#### Phase 2: Export and Clean the YAML

5.  **Export the Current State:**
    *Get the full live definition of the object and save it to a file.*
    ```bash
    kubectl get deploy lab11deploy -o yaml > lab11deploy.yaml
    ```

6.  **Delete the Live Object:**
    *Remove the imperatively created Deployment so you can recreate it declaratively.*
    ```bash
    kubectl delete deployments.apps lab11deploy
    ```

7.  **Clean the YAML File:**
    *Using a text editor (`vim`, `nano`, etc.), open `lab11deploy.yaml` and remove all fields that are automatically generated by the cluster. These fields are managed by Kubernetes and should not be present in a clean manifest file used for creation.*
    ```bash
    vim lab11deploy.yaml
    ```
    **Fields to Remove:**
    * `metadata.annotations` (some, not all)
    * `metadata.creationTimestamp`
    * `metadata.generation`
    * `metadata.resourceVersion`
    * `metadata.uid`
    * `status` (and everything underneath it)

8.  **Example of Cleaned YAML Snippet:**

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: lab11deploy
      labels:
        app: nginx
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - image: nginx
            name: nginx
            envFrom:
            - secretRef:
                name: lab11secret
            resources: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
          dnsPolicy: ClusterFirst
          restartPolicy: Always
          schedulerName: default-scheduler
          securityContext: {}
          terminationGracePeriodSeconds: 30
    ```

#### Phase 3: Declarative Creation and Verification

9.  **Create from the Clean YAML:**
    ```bash
    kubectl create -f lab11deploy.yaml
    ```

10. **Verify Environment Variable Injection:**
    *Get the Pod name first, then exec into it to check the environment.*
    ```bash
    POD_NAME=$(kubectl get pod -l app=lab11deploy -o jsonpath='{.items[0].metadata.name}')
    kubectl exec $POD_NAME -- env | grep MYPASSWORD
    # Expected Output: MYPASSWORD=verysecret
    ```

11. **Verify File Content (Expected Failure):**
    *This step confirms that the ConfigMap file content is **NOT** present, as we only injected the Secret variable and did not mount a ConfigMap volume.*
    ```bash
    kubectl exec $POD_NAME -- cat /usr/share/nginx/html/index.html
    # Expected Result: This will show the default Nginx index.html content, NOT an error, because the default page exists.
    # To confirm the *Secret* was injected and the *ConfigMap* was NOT, check the environment variable in the previous step.
---
